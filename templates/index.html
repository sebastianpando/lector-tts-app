<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PANDO DOGWALK</title>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    body {
      background: linear-gradient(135deg, #0f172a, #1e293b);
      color: #e2e8f0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 0; padding: 0;
    }
    header { text-align: center; padding: 20px 10px; }
    pre.ascii {
      font-family: monospace;
      font-size: 16px;
      line-height: 1.15em;
      margin: 0 auto 10px;
      display: inline-block;
      background: linear-gradient(90deg, #3b82f6, #a855f7, #ec4899, #facc15);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 8px rgba(255,255,255,0.25);
      white-space: pre;
    }
    section { padding: 20px; }
    h2 { margin-top: 30px; }
    .status { margin: 6px 0 12px; display:flex; align-items:center; gap:10px; }
    .status .muted { color:#9aa1ac; }
    .spinner {
      width: 18px; height: 18px; border: 3px solid rgba(255,255,255,0.25);
      border-top-color: #3b82f6; border-radius: 50%;
      animation: spin 0.9s linear infinite; display:none;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .progress-wrap { width:100%; background:#1f2937; border-radius:10px; height:10px; overflow:hidden; display:none; }
    .progress-bar { height:100%; width:0%; background:#3b82f6; transition: width .2s ease; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .speed { display:flex; gap:6px; align-items:center; margin-left:8px; }
    .speed-btn.active { outline: 2px solid #3b82f6; border-radius: 8px; }
    footer {
      margin-top: 40px;
      text-align: center;
      font-size: 14px;
      color: #94a3b8;
    }
    footer strong { color: #facc15; }
    .archive ul { list-style:none; padding:0; margin:0; display:grid; gap:8px; }
    .archive li {
      display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:10px;
      padding:8px 10px; border:1px solid #2a2f3a; border-radius:10px; background:#141821;
    }
    .archive a { color:#9fb5ff; text-decoration:none; word-break:break-all; }
    .archive .play { background:#16a34a; color:white; border:0; padding:6px 10px; border-radius:8px; }
    .archive .del  { background:#ef4444; color:white; border:0; padding:6px 10px; border-radius:8px; }
    .alert.error { background:#3a0e0e; border:1px solid #5e1a1a; padding:10px 12px; border-radius:10px; margin-top:8px; }
    input, select, textarea, button { font: inherit; border-radius:10px; }
    textarea, select { background:#141821; border:1px solid #2a2f3a; color:#e2e8f0; padding:10px 12px; width:100%; }
    button { background:#3b82f6; color:white; border:0; padding:10px 14px; font-weight:600; cursor:pointer; }
    button:hover { filter:brightness(1.07); }
    .player audio { width:100%; margin:8px 0; }
  </style>
</head>
<body>
  <header>
    <pre class="ascii">
PPPP    AAAA   N   N  DDDD    OOO
P   P  A    A  NN  N  D   D  O   O
PPPP   AAAAAA  N N N  D   D  O   O
P      A    A  N  NN  D   D  O   O
P      A    A  N   N  DDDD    OOO
    </pre>
    <p style="color:#94a3b8;">Lector en Ingl√©s y Espa√±ol TTS. Powered by Atlas üê∂</p>
  </header>

  <section class="composer">
    <form id="tts-form">
      <label for="text">Texto</label>
      <textarea id="text" name="text" rows="10" placeholder="Pega aqu√≠ tu texto‚Ä¶"></textarea>

      <div style="margin:10px 0; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <label for="lang" style="min-width:80px;">Idioma</label>
        <select id="lang" name="lang">
          <option value="es" selected>Espa√±ol (20% m√°s r√°pido)</option>
          <option value="en">English</option>
        </select>
      </div>

      <button type="submit">üîä Reproducir ahora</button>
      <div id="form-error" class="alert error" style="display:none;"></div>
    </form>
  </section>

  <section class="player">
    <h2>Status de reproducci√≥n</h2>
    <div class="status">
      <div id="spinner" class="spinner"></div>
      <span id="status-label" class="muted">Listo</span>
    </div>
    <div class="progress-wrap" id="progress-wrap">
      <div class="progress-bar" id="progress-bar"></div>
    </div>

    <audio id="player" controls preload="auto"></audio>

    <div class="controls">
      <button id="play" type="button">‚ñ∂Ô∏è Play</button>
      <button id="pause" type="button">‚è∏ Pausa</button>
      <button id="stop" type="button">‚èπ Detener</button>

      <div class="speed">
        <span class="muted">Velocidad:</span>
        <button type="button" class="speed-btn" data-rate="0.9">0.9√ó</button>
        <button type="button" class="speed-btn" data-rate="1.0">1.0√ó</button>
        <button type="button" class="speed-btn" data-rate="1.2">1.2√ó</button>
        <button type="button" class="speed-btn" data-rate="1.4">1.4√ó</button>
        <span id="speed-current" class="muted" style="margin-left:4px;">(1.0√ó)</span>
      </div>
    </div>
  </section>

  <section class="archive">
    <h2>Lecturas anteriores</h2>
    {% if items %}
      <ul>
        {% for it in items %}
        <li>
          <button class="play" data-file="{{ it }}">‚ñ∂</button>
          <a href="/audio/{{ it }}">{{ it }}</a>
          <button class="del" data-file="{{ it }}">üóë</button>
        </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="muted">A√∫n no hay lecturas archivadas.</p>
    {% endif %}
  </section>

  <footer>
    <small><strong>Pandix lo hizo otra vez</strong> ‚ú®</small>
  </footer>

  <!-- Intenta usar /static/main.js si existe; si est√° vac√≠o o falla, este script embebido se encarga -->
  <script>
    (function(){
      if (window.__ttsAppReady) return; // evita doble init si /static/main.js funciona
      const $ = (sel) => document.querySelector(sel);

      const form = $('#tts-form');
      const txt  = $('#text');
      const lang = $('#lang');
      const err  = $('#form-error');

      const player = $('#player');
      const playBtn = $('#play');
      const pauseBtn = $('#pause');
      const stopBtn = $('#stop');

      const spinner = $('#spinner');
      const statusLabel = $('#status-label');
      const pw = $('#progress-wrap');
      const pb = $('#progress-bar');
      const speedBtns = document.querySelectorAll('.speed-btn');
      const speedCurrent = $('#speed-current');

      let objectURL = null;

      function setStatus(s, busy=false) {
        statusLabel.textContent = s;
        spinner.style.display = busy ? 'inline-block' : 'none';
      }

      function showError(message) {
        err.textContent = message || 'Algo sali√≥ mal.';
        err.style.display = 'block';
      }
      function hideError() { err.style.display = 'none'; }

      function resetProgress() {
        pw.style.display = 'none';
        pb.style.width = '0%';
      }

      function updateProgress() {
        if (!isFinite(player.duration) || player.duration <= 0) return;
        const pct = (player.currentTime / player.duration) * 100;
        pw.style.display = 'block';
        pb.style.width = Math.min(100, pct) + '%';
      }

      player.addEventListener('timeupdate', updateProgress);
      player.addEventListener('ended', resetProgress);
      player.addEventListener('loadedmetadata', updateProgress);

      playBtn.addEventListener('click', () => player.play());
      pauseBtn.addEventListener('click', () => player.pause());
      stopBtn.addEventListener('click', () => { player.pause(); player.currentTime = 0; });

      speedBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          speedBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          const rate = parseFloat(btn.dataset.rate || '1.0');
          player.playbackRate = rate;
          speedCurrent.textContent = `(${rate.toFixed(1)}√ó)`;
        });
      });
      // Preseleccionar 1.0x
      const def = Array.from(speedBtns).find(b => b.dataset.rate === '1.0');
      if (def) def.classList.add('active');

      // --------- TTS: detecci√≥n de endpoint y solicitud ----------
      async function fetchTTSBlob(text, lang) {
        const candidates = [
          // 1) JSON POST t√≠pico
          async () => {
            const r = await fetch('/api/tts', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Accept': 'audio/*' },
              body: JSON.stringify({ text, lang })
            });
            if (!r.ok) throw new Error('api/tts no ok');
            const ct = r.headers.get('content-type') || '';
            if (!ct.startsWith('audio/')) throw new Error('api/tts no audio');
            return await r.blob();
          },
          // 2) GET /tts?text=&lang=
          async () => {
            const u = `/tts?text=${encodeURIComponent(text)}&lang=${encodeURIComponent(lang)}`;
            const r = await fetch(u, { headers: { 'Accept': 'audio/*' } });
            if (!r.ok) throw new Error('/tts no ok');
            const ct = r.headers.get('content-type') || '';
            if (!ct.startsWith('audio/')) throw new Error('/tts no audio');
            return await r.blob();
          },
          // 3) GET /speak?text=&lang=
          async () => {
            const u = `/speak?text=${encodeURIComponent(text)}&lang=${encodeURIComponent(lang)}`;
            const r = await fetch(u, { headers: { 'Accept': 'audio/*' } });
            if (!r.ok) throw new Error('/speak no ok');
            const ct = r.headers.get('content-type') || '';
            if (!ct.startsWith('audio/')) throw new Error('/speak no audio');
            return await r.blob();
          },
          // 4) GET /?text=&lang=  (el que aparece en tus logs antiguos)
          async () => {
            const u = `/?text=${encodeURIComponent(text)}&lang=${encodeURIComponent(lang)}`;
            const r = await fetch(u, { headers: { 'Accept': 'audio/*' } });
            if (!r.ok) throw new Error('/?text no ok');
            const ct = r.headers.get('content-type') || '';
            if (!ct.startsWith('audio/')) throw new Error('/?text no audio');
            return await r.blob();
          },
        ];

        let lastErr = null;
        for (const attempt of candidates) {
          try {
            return await attempt();
          } catch (e) {
            lastErr = e;
            // contin√∫a con el siguiente candidato
          }
        }
        throw lastErr || new Error('No se encontr√≥ endpoint de TTS disponible.');
      }

      async function handleSubmit(e) {
        e.preventDefault();
        hideError();
        const text = (txt.value || '').trim();
        const lng  = lang.value || 'es';
        if (!text) { showError('Escribe o pega un texto.'); return; }

        setStatus('Generando audio‚Ä¶', true);
        resetProgress();

        try {
          const blob = await fetchTTSBlob(text, lng);

          // libera URL anterior si existe
          if (objectURL) { URL.revokeObjectURL(objectURL); objectURL = null; }
          objectURL = URL.createObjectURL(blob);

          player.src = objectURL;
          await player.play();
          setStatus('Reproduciendo');
        } catch (e) {
          console.error(e);
          showError('No pude generar el audio. Verifica que el servidor exponga /api/tts, /tts, /speak o "/?text=&lang=".');
          setStatus('Error');
        } finally {
          spinner.style.display = 'none';
        }
      }

      form.addEventListener('submit', handleSubmit);

      // --------- Archivo: reproducir / borrar ----------
      document.addEventListener('click', async (ev) => {
        // Play archivo guardado
        if (ev.target && ev.target.matches('.archive .play')) {
          const f = ev.target.getAttribute('data-file');
          if (!f) return;
          hideError();
          resetProgress();
          setStatus('Cargando audio archivado‚Ä¶', true);
          try {
            const r = await fetch(`/audio/${encodeURIComponent(f)}`);
            if (!r.ok) throw new Error('No se pudo leer el archivo');
            const blob = await r.blob();
            if (objectURL) { URL.revokeObjectURL(objectURL); objectURL = null; }
            objectURL = URL.createObjectURL(blob);
            player.src = objectURL;
            await player.play();
            setStatus('Reproduciendo');
          } catch (e) {
            console.error(e);
            showError('No pude reproducir el archivo.');
            setStatus('Error');
          } finally {
            spinner.style.display = 'none';
          }
        }

        // Borrar archivo guardado
        if (ev.target && ev.target.matches('.archive .del')) {
          const f = ev.target.getAttribute('data-file');
          if (!f) return;
          if (!confirm(`¬øEliminar "${f}"?`)) return;
          try {
            const r = await fetch(`/audio/${encodeURIComponent(f)}`, { method: 'DELETE' });
            if (!r.ok) throw new Error('DELETE no ok');
            // Quitar el <li> del DOM
            const li = ev.target.closest('li');
            if (li) li.remove();
          } catch (e) {
            console.error(e);
            showError('No pude eliminar el archivo.');
          }
        }
      });

      window.__ttsAppReady = true;
      console.log('TTS UI lista (inline).');
    })();
  </script>

  <!-- Si tu /static/main.js est√° bien cargado, tambi√©n puede inicializar; este inline evita quedarte sin JS -->
  <script src="/static/main.js"></script>
</body>
</html>
