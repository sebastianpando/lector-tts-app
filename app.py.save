from flask import Flask

app = Flask(__name__)

@app.route("/")
def index():
    return "Hola, Render estÃ¡ funcionando ðŸš€"

import os, io, re, uuid, tempfile, shutil
from datetime import datetime
from flask import Flask, request, Response, render_template, redirect, url_for, abort, send_from_directory, jsonify
from gtts import gTTS

app = Flask(__name__)
ARCHIVE_DIR = os.path.join("static", "archive")
os.makedirs(ARCHIVE_DIR, exist_ok=True)

STREAM_JOBS = {}  # token -> {title, text}
MAX_WORDS = 5000

def slugify(s: str) -> str:
    s = s.strip().lower()
    s = re.sub(r"\s+", "-", s)
    s = re.sub(r"[^a-z0-9\-]+", "", s)
    return s[:60] or "lectura"

def split_text(text: str, max_chars: int = 1800):
    text = re.sub(r"\s+", " ", text).strip()
    parts = []
    while text:
        if len(text) <= max_chars:
            parts.append(text); break
        cut = text.rfind(". ", 0, max_chars)
        if cut == -1: cut = text.rfind(" ", 0, max_chars)
        if cut == -1: cut = max_chars
        parts.append(text[:cut+1].strip())
        text = text[cut+1:].strip()
    return parts

@app.route("/", methods=["GET"])
def index():
    items = [f for f in os.listdir(ARCHIVE_DIR) if f.endswith(".mp3")]
    items.sort(reverse=True)
    return render_template("index.html", items=items)

@app.route("/submit", methods=["POST"])
def submit():
    title = (request.form.get("title") or "").strip()
    text  = (request.form.get("text")  or "").strip()
    if not text:
        return redirect(url_for("index"))

    words = len(re.findall(r"\b\w+\b", text))
    if words > MAX_WORDS:
        items = [f for f in os.listdir(ARCHIVE_DIR) if f.endswith(".mp3")]
        items.sort(reverse=True)
        return render_template("index.html", items=items,
                               error=f"Texto supera {MAX_WORDS} palabras ({words}). CÃ³rtalo o envÃ­alo en partes.")

    token = str(uuid.uuid4())
    if not title:
        title = text[:40] + ("â€¦" if len(text) > 40 else "")
    STREAM_JOBS[token] = {"title": title, "text": text}
    return redirect(url_for("play", token=token))

@app.route("/play")
def play():
    token = request.args.get("token", "")
    items = [f for f in os.listdir(ARCHIVE_DIR) if f.endswith(".mp3")]
    items.sort(reverse=True)
    title = STREAM_JOBS.get(token, {}).get("title", "")
    return render_template("index.html", items=items, token=token, title=title)

@app.route("/stream")
def stream():
    token = request.args.get("token", "")
    job = STREAM_JOBS.get(token)
    if not job:
        abort(404)
    title = job["title"]; text = job["text"]
    del STREAM_JOBS[token]  # consumir

    tmp_fd, tmp_path = tempfile.mkstemp(suffix=".mp3")
    os.close(tmp_fd)

    def generate():
        chunks = split_text(text)
        for chunk in chunks:
            tts = gTTS(chunk, lang="es")
            buf = io.BytesIO()
            tts.write_to_fp(buf)
            data = buf.getvalue()
            with open(tmp_path, "ab") as out:
                out.write(data)
            yield data

        stamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        final_name = f"{stamp}_{slugify(title)}.mp3"
        fin.0.0", port=8000, 
